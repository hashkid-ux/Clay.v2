#!/usr/bin/env node
/**
 * Backend/DEPLOYMENT_GUIDE.txt - Complete Wasabi & Production Deployment Guide
 * 
 * This guide covers:
 * 1. Wasabi S3-compatible storage setup for call recordings
 * 2. Environment variable configuration
 * 3. Database initialization
 * 4. Railway deployment
 * 5. Monitoring & troubleshooting
 */

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ WASABI STORAGE SETUP (for call recordings)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Why Wasabi instead of AWS S3?
â€¢ 80% cheaper: $5.99/month flat vs AWS variable costs
â€¢ Perfect for recording storage: 1000s of uploads/month
â€¢ S3-compatible: No code changes needed
â€¢ Unlimited buckets, no hidden charges

Step 1: Create Wasabi Account
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Visit: https://wasabi.com
2. Sign up (free account)
3. Login to dashboard
4. Go to: Access Keys section
5. Create new access key pair
6. Note down:
   - Access Key ID: wasabi_access_key_xxxxx
   - Secret Access Key: wasabi_secret_key_xxxxx
7. Select region: US East 1 (good latency for India)

Step 2: Create S3 Bucket
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. In Wasabi Dashboard â†’ Buckets â†’ "Create Bucket"
2. Bucket name: caly-call-recordings
3. Region: us-east-1
4. Click Create

Step 3: Configure Bucket Lifecycle (auto-cleanup)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Go to: Bucket â†’ Lifecycle Policies
2. Create policy:
   - Prefix: recordings/
   - Action: Delete objects
   - After: 90 days (or your preference)
3. Save

This automatically deletes old recordings to control costs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ ENVIRONMENT VARIABLES (Backend/.env)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CRITICAL VARIABLES (Must have):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
NODE_ENV=production
PORT=8080
DATABASE_URL=postgresql://postgres:password@host:5432/caly_production

# JWT Authentication
JWT_SECRET=<YOUR-32-CHAR-RANDOM-SECRET>
JWT_EXPIRY=24h
REFRESH_TOKEN_EXPIRY=7d

# OpenAI API
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxx
OPENAI_REALTIME_MODEL=gpt-4o-realtime-preview

# Exotel (Voice Calls)
EXOTEL_SID=your-exotel-sid
EXOTEL_TOKEN=your-exotel-token
EXOTEL_PHONE_NUMBER=+91xxxxxxxxxx

# Wasabi (Call Recordings) â­ NEW
WASABI_ENABLED=true
WASABI_ACCESS_KEY_ID=your-wasabi-access-key
WASABI_SECRET_ACCESS_KEY=your-wasabi-secret-key
WASABI_REGION=us-east-1
WASABI_BUCKET_NAME=caly-call-recordings
WASABI_ENDPOINT=https://s3.wasabisys.com
WASABI_PUBLIC_URL=https://caly-call-recordings.s3.wasabisys.com

# Email (OTP Verification)
SMTP_HOST=smtp.gmail.com
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-gmail-app-password

# Security & Webhook
SESSION_SECRET=<YOUR-32-CHAR-RANDOM-SECRET>
ENCRYPTION_KEY=<YOUR-32-CHAR-RANDOM-SECRET>
WEBHOOK_BASE_URL=https://calybackend-production.up.railway.app
CORS_ORIGIN=https://app.caly.yourdomain.com

Generate Random Secrets:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—„ï¸ DATABASE INITIALIZATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Step 1: Initialize Main Schema
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
npm run init-db
# This creates all required tables

Step 2: Initialize Wasabi Schema
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
node scripts/init-wasabi-db.js
# This adds recording_url column and call_charges table

Step 3: Verify Installation
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
psql $DATABASE_URL -c "
  SELECT table_name FROM information_schema.tables 
  WHERE table_schema = 'public' ORDER BY table_name;
"

Expected tables:
- calls (with recording_url column)
- call_charges (for billing)
- clients (with Shopify/Exotel fields)
- company_users (auth)
- ... and others

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ RAILWAY DEPLOYMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Step 1: Connect GitHub Repository
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Go to: https://railway.app/dashboard
2. Click "New Project" â†’ "Deploy from GitHub"
3. Select your repository
4. Click Deploy

Step 2: Add PostgreSQL Service
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. In Railway dashboard â†’ Click "+" â†’ PostgreSQL
2. Connect to the Node.js service
3. This automatically sets DATABASE_URL

Step 3: Set Environment Variables
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Go to: Node.js service â†’ Variables
2. Add all variables from .env file:
   - JWT_SECRET
   - OPENAI_API_KEY
   - EXOTEL_SID, EXOTEL_TOKEN, EXOTEL_PHONE_NUMBER
   - WASABI_ACCESS_KEY_ID
   - WASABI_SECRET_ACCESS_KEY
   - WASABI_REGION
   - WASABI_BUCKET_NAME
   - WASABI_ENDPOINT
   - WASABI_PUBLIC_URL
   - SMTP_HOST, SMTP_USER, SMTP_PASS
   - CORS_ORIGIN (your frontend domain)
   - ... and others

Step 4: Configure Build & Deploy
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Go to: Deployments â†’ Settings
2. Build Command: npm install
3. Start Command: npm run deploy
   (This runs init-db, then starts server)
4. Save

Step 5: Run Migrations
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Option A: Via Railway Console
- Go to Deployments â†’ Connect â†’ Console
- Run: node scripts/init-wasabi-db.js

Option B: Via Custom Start Script
- Update start command to: node scripts/init-db.js && node scripts/init-wasabi-db.js && node server.js

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” VERIFY WASABI CONFIGURATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Check if Wasabi is working:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
curl https://your-railway-url.railway.app/api/recordings/storage/stats \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

Expected response:
{
  "bucket": "caly-call-recordings",
  "fileCount": 0,
  "totalSizeBytes": 0,
  "totalSizeMB": "0.00",
  "totalSizeGB": "0.00",
  "estimatedMonthlyCost": "$5.99"
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š CALL FLOW WITH WASABI INTEGRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Call starts
   â”œâ”€ STSSession opens WebSocket to OpenAI Realtime API
   â”œâ”€ Audio captured in memory (session.audioBuffer)
   â””â”€ Conversation happens

2. Call ends (endSession)
   â”œâ”€ STSSession stopped
   â”œâ”€ Audio buffer ready
   â”œâ”€ wasabiStorage.uploadCallRecording() called
   â”œâ”€ File uploaded to Wasabi: recordings/YYYY-MM-DD/callId.mp3
   â”œâ”€ Recording URL stored in database (calls.recording_url)
   â”œâ”€ Call charges calculated (duration * â‚¹30/minute)
   â”œâ”€ Call data saved to calls table
   â””â”€ Session cleaned up

3. Retrieve recording later
   â”œâ”€ GET /api/recordings/:callId
   â”œâ”€ Backend validates client ownership
   â”œâ”€ Generates pre-signed URL (valid 1 hour)
   â”œâ”€ Frontend plays audio via <audio> tag
   â””â”€ Pre-signed URL expires automatically

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’° COST BREAKDOWN (Monthly Estimate)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: 1000 calls/month, 5 min avg = 5000 minutes

Wasabi Storage:
â”œâ”€ 5000 min * 5KB/sec * 60 = ~1.5 GB
â”œâ”€ Wasabi flat rate: $5.99/month (includes 1TB)
â””â”€ Per-call cost: $0.006

AWS S3 (for comparison):
â”œâ”€ 1.5 GB * $0.023 = $34.50 storage
â”œâ”€ Data transfer: ~$0.009 per call = $9/month
â”œâ”€ API requests: ~$0.001/month
â””â”€ Total: ~$44/month (7x more expensive!)

Savings with Wasabi: ~$39/month per 1000 calls!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ› TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Issue: "Wasabi disabled - recording not uploaded"
Solution:
  1. Check WASABI_ENABLED=true in .env
  2. Verify WASABI_ACCESS_KEY_ID and WASABI_SECRET_ACCESS_KEY are set
  3. Check Railway environment variables

Issue: "Failed to upload to Wasabi" error
Solution:
  1. Verify Wasabi credentials are correct
  2. Check bucket name matches WASABI_BUCKET_NAME
  3. Verify bucket exists in Wasabi dashboard
  4. Check IAM permissions in Wasabi

Issue: "Invalid Wasabi endpoint"
Solution:
  1. WASABI_ENDPOINT must be: https://s3.wasabisys.com
  2. For other regions, use: s3.{region}.wasabisys.com

Issue: Recordings not appearing in database
Solution:
  1. Check database connection: node scripts/init-wasabi-db.js
  2. Verify recording_url column exists: \d calls
  3. Check call_charges table was created

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… PRODUCTION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before going live, verify:

â–¡ Database
  â–¡ PostgreSQL running on Railway
  â–¡ All tables created (init-db.js ran)
  â–¡ Wasabi schema initialized (init-wasabi-db.js ran)
  â–¡ recording_url column exists on calls table
  â–¡ call_charges table created

â–¡ Environment Variables
  â–¡ JWT_SECRET is 32+ random characters
  â–¡ OPENAI_API_KEY is valid
  â–¡ EXOTEL credentials configured
  â–¡ WASABI credentials valid (test in console)
  â–¡ SMTP configured for OTP emails
  â–¡ CORS_ORIGIN matches frontend domain

â–¡ Wasabi Storage
  â–¡ Wasabi account created
  â–¡ Bucket created (caly-call-recordings)
  â–¡ Access key pair generated
  â–¡ Lifecycle policy set (auto-delete after 90 days)
  â–¡ Public URL accessible

â–¡ Application
  â–¡ Server starts without errors
  â–¡ Database connection successful
  â–¡ Wasabi connection tested
  â–¡ /api/health endpoint working
  â–¡ Recording upload tested with test call
  â–¡ Recording retrieval tested
  â–¡ Pre-signed URL generation working

â–¡ Monitoring
  â–¡ Logs configured (Winston logger)
  â–¡ Error tracking set up (Sentry optional)
  â–¡ Storage monitoring dashboard set up
  â–¡ Cost alerts configured

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

For more help: https://wasabi.com/support or check logs via Railway console
